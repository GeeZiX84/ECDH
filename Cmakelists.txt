cmake_minimum_required(VERSION 3.16)

project(ECDH
    VERSION 1.0
    LANGUAGES CXX
)

# ===============================
# C++ standard
# ===============================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ===============================
# Build type default
# ===============================
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Choose the build type" FORCE)
endif()

# ===============================
# Source files
# ===============================
file(GLOB_RECURSE ECDH_SOURCES
    ${PROJECT_SOURCE_DIR}/src/*.cpp
)

# ===============================
# Core library
# ===============================
add_library(ecdh_lib
    ${ECDH_SOURCES}
)

# ===============================
# Include directories
# ===============================
target_include_directories(ecdh_lib
    PUBLIC
        ${PROJECT_SOURCE_DIR}/include
)

# ===============================
# Dependencies
# ===============================
# nlohmann/json (header-only)
find_package(nlohmann_json 3.2.0 QUIET)
if(nlohmann_json_FOUND)
    target_link_libraries(ecdh_lib PUBLIC nlohmann_json::nlohmann_json)
endif()

# Boost Multiprecision
find_package(Boost 1.71 REQUIRED COMPONENTS multiprecision)
if(Boost_FOUND)
    target_include_directories(ecdh_lib PUBLIC ${Boost_INCLUDE_DIRS})
endif()

# ===============================
# Windows system libraries
# ===============================
if(WIN32)
    if(MINGW)
        message(STATUS "Configuring for MinGW-w64")

        target_include_directories(ecdh_lib
            SYSTEM PUBLIC
                /mingw64/include
                /mingw64/include/winapi
                /mingw64/include/shared
                /mingw64/include/um
                /mingw64/include/ucrt
        )

        target_link_libraries(ecdh_lib
            PUBLIC
                bcrypt
                advapi32
        )
    endif()
endif()

# ===============================
# Compiler warnings
# ===============================
if(MSVC)
    target_compile_options(ecdh_lib PRIVATE /W4 /permissive-)
else()
    target_compile_options(ecdh_lib PRIVATE -Wall -Wextra -Wpedantic)
endif()

# ===============================
# Demo executable
# ===============================
if(EXISTS "${PROJECT_SOURCE_DIR}/examples/ecdh_demo.cpp")
    add_executable(ecdh_demo
        ${PROJECT_SOURCE_DIR}/examples/ecdh_demo.cpp
    )

    target_link_libraries(ecdh_demo PRIVATE ecdh_lib)

    # Все exe будут в bin/
    set_target_properties(ecdh_demo PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/bin
    )
else()
    message(STATUS "examples/ecdh_demo.cpp not found — demo target will not be built")
endif()

